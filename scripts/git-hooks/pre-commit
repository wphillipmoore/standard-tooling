#!/usr/bin/env bash
# Managed by standard-tooling — DO NOT EDIT in downstream repos.
# Canonical source: https://github.com/wphillipmoore/standard-tooling
set -euo pipefail

current_branch="$(git rev-parse --abbrev-ref HEAD)"

# Block detached HEAD unconditionally.
if [[ "$current_branch" == "HEAD" ]]; then
  echo "ERROR: detached HEAD is not allowed for commits." >&2
  echo "Create a short-lived branch and open a PR." >&2
  exit 1
fi

# Block commits to protected branches (universal set — safe for all models).
case "$current_branch" in
  develop|release|main)
    echo "ERROR: direct commits to protected branches are forbidden ($current_branch)." >&2
    echo "Create a short-lived branch and open a PR." >&2
    exit 1
    ;;
esac

# Read branching_model from the repository profile.
repo_root="$(git rev-parse --show-toplevel)"
profile_file="$repo_root/docs/repository-standards.md"
branching_model=""

if [[ -f "$profile_file" ]]; then
  while IFS= read -r line; do
    if [[ "$line" =~ ^[[:space:]-]*branching_model:[[:space:]]*(.+)$ ]]; then
      branching_model="${BASH_REMATCH[1]}"
      break
    fi
  done < "$profile_file"
fi

# Set allowed branch prefixes based on branching model.
case "$branching_model" in
  docs-single-branch)
    allowed_regex='^(feature|bugfix)/'
    allowed_display="feature/* or bugfix/*"
    ;;
  application-promotion)
    allowed_regex='^(feature|bugfix|hotfix|promotion)/'
    allowed_display="feature/*, bugfix/*, hotfix/*, or promotion/*"
    ;;
  library-release)
    allowed_regex='^(feature|bugfix|hotfix|release)/'
    allowed_display="feature/*, bugfix/*, hotfix/*, or release/*"
    ;;
  "")
    echo "WARNING: branching_model not found in $profile_file; falling back to feature/*/bugfix/*." >&2
    allowed_regex='^(feature|bugfix)/'
    allowed_display="feature/* or bugfix/*"
    ;;
  *)
    echo "ERROR: unrecognized branching_model '$branching_model' in $profile_file." >&2
    exit 1
    ;;
esac

if [[ ! "$current_branch" =~ $allowed_regex ]]; then
  echo "ERROR: branch name must use $allowed_display ($current_branch)." >&2
  echo "Rename the branch before committing." >&2
  exit 1
fi

# Validate issue-number naming for work branches.
# Format: {type}/{issue}-{description}
# Exempt: release/* (automated by the publish workflow, no issue association).
issue_required_regex='^(feature|bugfix|hotfix)/'
issue_format_regex='^(feature|bugfix|hotfix)/[0-9]+-[a-z0-9][a-z0-9-]*$'

if [[ "$current_branch" =~ $issue_required_regex ]]; then
  if [[ ! "$current_branch" =~ $issue_format_regex ]]; then
    echo "ERROR: branch name must include a repo issue number ($current_branch)." >&2
    echo "Expected format: {type}/{issue}-{description}" >&2
    echo "Example: feature/42-add-caching" >&2
    exit 1
  fi
fi
