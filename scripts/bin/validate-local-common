#!/usr/bin/env bash
# Managed by standard-tooling — DO NOT EDIT in downstream repos.
# Canonical source: https://github.com/wphillipmoore/standard-tooling
# validate-local-common — shared checks run for ALL repos.
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

run() {
  echo "Running: $*"
  "$@"
}

# -- required tools ----------------------------------------------------------

missing=()
command -v shellcheck >/dev/null 2>&1 || missing+=("shellcheck")
command -v markdownlint >/dev/null 2>&1 || missing+=("markdownlint")

if [[ ${#missing[@]} -gt 0 ]]; then
  echo "ERROR: required tools not found: ${missing[*]}" >&2
  exit 1
fi

# -- repo profile validation -------------------------------------------------
# Prefer PATH-based command, fall back to known locations.

if command -v repo-profile >/dev/null 2>&1; then
  run repo-profile
elif [[ -f "$repo_root/scripts/bin/repo-profile" ]]; then
  run "$repo_root/scripts/bin/repo-profile"
fi

# -- markdown lint -----------------------------------------------------------

if command -v markdown-standards >/dev/null 2>&1; then
  run markdown-standards
elif [[ -f "$repo_root/scripts/bin/markdown-standards" ]]; then
  run "$repo_root/scripts/bin/markdown-standards"
fi

# -- shellcheck on all shell scripts -----------------------------------------

shell_files=()
while IFS= read -r f; do
  shell_files+=("$f")
done < <(
  find "$repo_root/scripts" -type f \( -name '*.sh' -o -path '*/git-hooks/*' -o -path '*/bin/*' \) 2>/dev/null
)

if [[ ${#shell_files[@]} -gt 0 ]]; then
  run shellcheck "${shell_files[@]}"
fi
