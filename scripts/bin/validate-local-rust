#!/usr/bin/env bash
# Managed by standard-tooling — DO NOT EDIT in downstream repos.
# Canonical source: https://github.com/wphillipmoore/standard-tooling
# validate-local-rust — Rust-specific local validation checks.
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"

run() {
  echo "Running: $*"
  "$@"
}

# -- required tools ----------------------------------------------------------

missing=()
command -v cargo >/dev/null 2>&1 || missing+=("cargo")
command -v cargo-clippy >/dev/null 2>&1 || missing+=("clippy")
command -v rustfmt >/dev/null 2>&1 || missing+=("rustfmt")
command -v cargo-deny >/dev/null 2>&1 || missing+=("cargo-deny")

if [[ ${#missing[@]} -gt 0 ]]; then
  echo "ERROR: required tools not found: ${missing[*]}" >&2
  exit 1
fi

# -- auto-discover workspace from Cargo.toml --------------------------------

manifest_dir=""
if [[ -f "$repo_root/Cargo.toml" ]]; then
  manifest_dir="$repo_root"
else
  # Search one level down for Cargo.toml.
  while IFS= read -r f; do
    manifest_dir="$(dirname "$f")"
    break
  done < <(find "$repo_root" -maxdepth 2 -name Cargo.toml -not -path '*/target/*' 2>/dev/null)
fi

if [[ -z "$manifest_dir" ]]; then
  echo "ERROR: could not find Cargo.toml" >&2
  exit 1
fi

echo "Cargo manifest directory: $manifest_dir"
cd "$manifest_dir"

# -- format ------------------------------------------------------------------

run cargo fmt --all -- --check

# -- lint --------------------------------------------------------------------

run cargo clippy -- -D warnings

# -- unit tests --------------------------------------------------------------

run cargo test

# -- coverage ----------------------------------------------------------------

if command -v cargo-llvm-cov >/dev/null 2>&1; then
  run cargo llvm-cov --fail-under-lines 0
fi

# -- dependency audit and license compliance ---------------------------------

run cargo deny check
