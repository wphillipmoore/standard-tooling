name: Publish dev container images

on:
  push:
    branches:
      - develop
      - main
    paths:
      - "docker/**"
  workflow_dispatch:

permissions:
  packages: write
  contents: read
  security-events: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  hadolint:
    name: Lint Dockerfiles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download Hadolint
        run: |
          curl -sL "https://github.com/hadolint/hadolint/releases/download/v2.14.0/hadolint-Linux-x86_64" \
            -o /usr/local/bin/hadolint
          chmod +x /usr/local/bin/hadolint

      - name: Run Hadolint
        run: hadolint docker/*/Dockerfile

  build-scan-push:
    name: "publish: dev-${{ matrix.language }}:${{ matrix.version }}"
    needs: [hadolint]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: ruby
            version: "3.2"
            build-arg: RUBY_VERSION
          - language: ruby
            version: "3.3"
            build-arg: RUBY_VERSION
          - language: ruby
            version: "3.4"
            build-arg: RUBY_VERSION
          - language: python
            version: "3.12"
            build-arg: PYTHON_VERSION
          - language: python
            version: "3.13"
            build-arg: PYTHON_VERSION
          - language: python
            version: "3.14"
            build-arg: PYTHON_VERSION
          - language: java
            version: "17"
            build-arg: JDK_VERSION
          - language: java
            version: "21"
            build-arg: JDK_VERSION
          - language: go
            version: "1.25"
            build-arg: GO_VERSION
          - language: go
            version: "1.26"
            build-arg: GO_VERSION

    env:
      IMAGE: "ghcr.io/wphillipmoore/dev-${{ matrix.language }}:${{ matrix.version }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        run: |
          docker build \
            --build-arg "${{ matrix.build-arg }}=${{ matrix.version }}" \
            -t "$IMAGE" \
            "docker/${{ matrix.language }}"

      - name: Trivy image scan
        uses: wphillipmoore/standard-actions/actions/security/trivy@develop
        with:
          scan-type: image
          scan-ref: ${{ env.IMAGE }}
          exit-code: "1"
          sarif-category: "trivy-image-${{ matrix.language }}-${{ matrix.version }}"
          trivyignores: .trivyignore

      - name: Push image
        run: |
          docker push "$IMAGE"

      - name: Get image digest
        id: digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE" | cut -d'@' -f2)
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: "ghcr.io/wphillipmoore/dev-${{ matrix.language }}"
          subject-digest: ${{ steps.digest.outputs.digest }}
